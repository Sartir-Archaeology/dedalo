import{event_manager}from"../../../common/js/event_manager.js";import{data_manager}from"../../../common/js/data_manager.js";import{get_instance,delete_instance}from"../../../common/js/instances.js";import{common}from"../../../common/js/common.js";import{tool_common,trigger_request}from"../../../tool_common/js/tool_common.js";import{render_tool_time_machine,add_component}from"./render_tool_time_machine.js";export const tool_time_machine=function(){return this.id,this.model,this.mode,this.lang,this.node,this.ar_instances,this.status,this.events_tokens=[],this.type,this.caller,this.section_tm,this.button_apply,this.selected_matrix_id,this.trigger_url,this.modal_container,!0};tool_time_machine.prototype.refresh=common.prototype.refresh,tool_time_machine.prototype.render=common.prototype.render,tool_time_machine.prototype.destroy=common.prototype.destroy,tool_time_machine.prototype.edit=render_tool_time_machine.prototype.edit,tool_time_machine.prototype.init=async function(t){const e=this;return e.langs=page_globals.dedalo_projects_default_langs,e.trigger_url=DEDALO_TOOLS_URL+"/tool_time_machine/trigger.tool_time_machine.php",e.events_tokens.push(event_manager.subscribe("tm_edit_record",async t=>{add_component(e,e.preview_component_container,e.lang,t.date,"tm",t.matrix_id),e.button_apply.classList.remove("hide"),e.selected_matrix_id=t.matrix_id})),tool_common.prototype.init.call(this,t)},tool_time_machine.prototype.build=async function(t=!1){const e=new data_manager,o={typo:"source",tipo:this.caller.tipo,section_tipo:this.caller.section_tipo,section_id:this.caller.section_id,model:"section_tm",lang:this.caller.lang,pagination:{total:0,offset:0,limit:10}},i=await e.get_element_context(o);return this.section_tm_context=i.result,tool_common.prototype.build.call(this,t)},tool_time_machine.prototype.load_section=async function(){const t=this.section_tm_context,e=await get_instance({model:"section",tipo:this.caller.section_tipo,section_tipo:this.caller.section_tipo,section_id:this.caller.section_id,mode:"list_tm",lang:this.caller.lang,section_lang:this.caller.lang,type:"section",sqo_context:{show:t},id_variant:"time_machine"});return e.caller=this,this.ar_instances.push(e),await e.build(!0),!0===SHOW_DEBUG&&console.log("[tool_time_machine.load_section] section_instance:",e),this.ar_instances.push(e),e},tool_time_machine.prototype.load_component=async function(t,e="tm",o=null){const i=this,n=i.caller,a=JSON.parse(JSON.stringify(n.context));void 0!==t&&(a.lang=t);const s={model:n.model,tipo:n.tipo,section_tipo:n.section_tipo,section_id:n.section_id,mode:e,lang:a.lang,section_lang:n.section_lang,type:n.type,context:a,data:{value:[]},datum:n.datum,id_variant:"time_machine"};o&&(s.matrix_id=o);const c=await get_instance(s);o&&(c.caller=i),await c.build(!0);const _=i.ar_instances.find(t=>t===c);return c!==i.caller&&void 0===_&&i.ar_instances.push(c),c},tool_time_machine.prototype.apply_value=async function(){const t=this,e=t.lang,o=t.selected_matrix_id,i={url:t.trigger_url,mode:"apply_value",section_id:t.caller.section_id,section_tipo:t.caller.section_tipo,tipo:t.caller.tipo,lang:e,matrix_id:o},n=await trigger_request(t.trigger_url,i);return t.modal_container.close().then(()=>{t.caller.refresh()}),!0===SHOW_DEBUG&&console.log("[tool_time_machine.apply_value] trigger_response:",n),n};