import{data_manager}from"../../../core/common/js/data_manager.js";import{get_instance,delete_instance}from"../../../core/common/js/instances.js";import{common}from"../../../core/common/js/common.js";import{tool_common}from"../../tool_common/js/tool_common.js";import{render_tool_upload}from"./render_tool_upload.js";export const tool_upload=function(){return this.id,this.model,this.mode,this.node,this.ar_instances,this.status,this.events_tokens,this.type,this.caller,this.max_size_bytes,!0};tool_upload.prototype.render=common.prototype.render,tool_upload.prototype.destroy=common.prototype.destroy,tool_upload.prototype.edit=render_tool_upload.prototype.edit,tool_upload.prototype.init=async function(e){return this.trigger_url=DEDALO_TOOLS_URL+"/tool_upload/trigger.tool_upload.php",tool_common.prototype.init.call(this,e)},tool_upload.prototype.build=async function(e=!1){const o=tool_common.prototype.build.call(this,e);await get_system_info(this);return o};const get_system_info=async function(e){const o=await fetch(e.trigger_url,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrer:"no-referrer",body:JSON.stringify({mode:"get_system_info"})}).then((function(e){if(!e.ok)throw Error(e.statusText);return e})).then(e=>e.json()).catch(e=>(console.error("!!!!! REQUEST ERROR: ",e),{result:!1,msg:e.message,error:e}));return e.max_size_bytes=o.result.max_size_bytes,e.sys_get_temp_dir=o.result.sys_get_temp_dir,e.upload_tmp_dir=o.result.upload_tmp_dir,e.upload_tmp_perms=o.result.upload_tmp_perms,e.session_cache_expire=o.result.session_cache_expire,o.result};tool_upload.prototype.upload_file=async function(e,o,t,r,n){const s=this,a=s.caller.context.allowed_extensions,i=e.name.split(".").pop().toLowerCase();if(!a.includes(i))return alert(get_label.extension_no_valida+": \n"+i+"\nUse any of: \n"+JSON.stringify(a)),!1;const l=e.size;if(l>s.max_size_bytes)return alert(get_label.fichero_demasiado_grande+" Max file size is "+Math.floor(s.max_size_bytes/1048576)+" MB and current file is "+Math.floor(l/1048576)),!1;const p=n.querySelector(".progress_info"),d=n.querySelector(".progress_line"),c=o.querySelector(".filedrag");c.classList.add("loading_file");const _=new FormData;_.append("mode","upload_file"),_.append("component_tipo",s.caller.tipo),_.append("section_tipo",s.caller.section_tipo),_.append("section_id",s.caller.section_id),_.append("quality",s.caller.context.default_target_quality),_.append("fileToUpload",e);const u=new XMLHttpRequest;return u.upload.addEventListener("loadstart",(function(o){r.src="",d.value=0,t.innerHTML='<span class="blink">Loading file '+e.name+"</span>"}),!1),u.upload.addEventListener("load",(function(o){t.innerHTML='<span class="blink">Processing file '+e.name+"</span>"}),!1),u.upload.addEventListener("error",(function(o){t.innerHTML=`<span class="error">${get_label.error_al_subir_el_archivo} ${e.name}</span>`}),!1),u.upload.addEventListener("abort",(function(e){t.innerHTML='<span class="error">User aborts upload</span>'}),!1),u.upload.addEventListener("progress",(function(e){const o=parseInt(e.loaded/e.total*100);p.innerHTML="Upload progress: "+o+" %",d.value=o}),!1),u.addEventListener("load",(function(e){const o=JSON.parse(e.target.response);return o?(!0===SHOW_DEBUG&&console.log("upload_file.XMLHttpRequest load response:",o),t.innerHTML=o.msg,o.preview_url&&(r.src=o.preview_url+"?"+(new Date).getTime()),c.classList.remove("loading_file"),s.caller.refresh().then(e=>{}),!0):(console.error("Error in XMLHttpRequest load response. Nothing is received"),!1)}),!1),u.open("POST",s.trigger_url,!0),console.log("file.name:",e),u.setRequestHeader("X-File-Name",encodeURIComponent(e.name)),u.send(_),!0};